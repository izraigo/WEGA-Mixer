<!DOCTYPE html>
<link rel='stylesheet' type='text/css' href='style.css'>
Status: <span id='state'></span><br>
<br><span id='weight'></span><br>
<br>Sum A = <span id='sumA'></span>
<br>Sum B = <span id='sumB'></span>
<br>Timer = <span id='timer'></span>
<form action="/rest/start">
    <p>P1 = <input type='text' name='p1'/> <span id='n1'></span><span id='r1'/></p>
    <p>P2 = <input type='text' name='p2'/> <span id='n2'></span><span id='r2'/></p>
    <p>P3 = <input type='text' name='p3'/> <span id='n3'></span><span id='r3'/></p>    
    <p>P4 = <input type='text' name='p4'/> <span id='n4'></span><span id='r4'/></p>
    <p>P5 = <input type='text' name='p5'/> <span id='n5'></span><span id='r5'/></p>    
    <p>P6 = <input type='text' name='p6'/> <span id='n6'></span><span id='r6'/></p>
    <p>P7 = <input type='text' name='p7'/> <span id='n7'></span><span id='r7'/></p>    
    <p>P8 = <input type='text' name='p8'/> <span id='n8'></span><span id='r8'/></p>
    <p id='actions'>
        <input type='submit' value='Start'/>
        <input type='button' onclick="tare();" value='Tare'/>
        <input type='button' onclick='location.href = "calibration";' value='Calibration'/>
    </p>
</form>
ver : <span id='version'></span>
<script>
function loadMeta() {
    fetch('/rest/meta').then(r => r.json()).then(r => {
        let params = new URLSearchParams(location.search);
        document.getElementById('version').textContent = r.version;
        for (let i = 1; i <= r.names.length; i++) {
            document.getElementById('n' + i).textContent = r.names[i - 1];
            let goal = params.get('p' + i);
            if (goal) {
                document.getElementsByName('p' + i)[0].value = goal;
                goalIsSet = true;
            }
        }
        const evtSource = new EventSource("/rest/events");
        evtSource.addEventListener("state",  event => onStateUpdate(JSON.parse(event.data)));
        evtSource.addEventListener("scales", event => onScalesUpdate(JSON.parse(event.data)));
        evtSource.addEventListener("report", event => onReportUpdate(JSON.parse(event.data)));
    }).catch(e => setTimeout(loadMeta, 5000));
}

function onStateUpdate(event) {
    document.getElementById('state').textContent = event.state;
    document.querySelectorAll("input").forEach(e => e.disabled = (event.state != "Ready"));
}

function onScalesUpdate(event) {
    document.getElementById('weight').textContent = event.value;
}

function onReportUpdate(event) {
    document.getElementById('weight').textContent = "";
    document.getElementById('sumA').textContent = event.sumA.toFixed(2);
    document.getElementById('sumB').textContent = event.sumB.toFixed(2);
    document.getElementById('timer').textContent = new Date(event.timer * 1000).toISOString().substr(11, 8);
    for (let i = 1; i <= event.goal.length; i++) {
        let goal = event.goal[i - 1];
        if (!goalIsSet) {
            document.getElementsByName('p' + i)[0].value = goal.toFixed(2);
        }
        let vol = event.result[i - 1];
        let e = document.getElementById('r' + i);
        e.textContent = vol ? '=' + vol.toFixed(2) + ' ' + (vol / goal * 100 - 100).toFixed(2) + '%' : '';
        e.style.fontWeight = event.pumpWorking == i - 1 ? 'bold' : 'normal'; 
        document.getElementById('n' + i).style.fontWeight = event.pumpWorking == i - 1 ? 'bold' : 'normal'; 
    }
}

function tare() {
    document.getElementById("weight").textContent = "Wait";
    fetch("/rest/tare")
    .then(r => {
        if (r.ok) return document.getElementById("weight").textContent = "Ok";
        throw new Error('Busy try later');
    })
    .catch(e => document.getElementById("weight").textContent = e);
}


goalIsSet = false;
loadMeta();

</script>   
